<%- include('./partials/header'); %>

    <body class="bg-gray-100 font-sans">
        <div class="max-w-screen-md mx-auto p-4">
            <div class="flex justify-between items-center py-4">
                <button class="text-lg"><a href="/products"><i class="ri-arrow-left-s-line"></i></a></button>
                <h1 class="text-xl font-semibold">Checkout</h1>
                <button class="text-lg">Share</button>
            </div>

            <div class="bg-white p-4 rounded-lg shadow mb-4">
                <div class="flex items-center gap-4">
                    <i
                        class="w-10 h-10 flex items-center justify-center rounded bg-zinc-100 text-2xl ri-timer-line"></i>
                    <div>
                        <p class="text-sm font-medium">Delivery in <%= Math.floor((Math.random()*10)+3) %> minutes</p>
                        <p class="text-xs text-gray-500">Shipment of <%= cart.length %> item(s)</p>
                    </div>
                </div>

                <% cart.forEach(elem=> { %>
                    <div class="flex items-center mt-4">
                        <img src="data:image/jpg;base64, <%= elem.image.toString('base64') %>" alt="<%= elem.name %>"
                            class="w-16 h-16 rounded">
                        <div class="ml-4">
                            <p>
                                <%= elem.name %>
                            </p>
                            <p class="text-xs text-gray-500"></p>
                        </div>
                        <div class="ml-auto">
                            <div class="flex items-center justify-center bg-green-700 text-white rounded-md">
                                <a href="/cart/remove/<%= elem._id %>" class="px-2 py-1 rounded"><i
                                        class="ri-subtract-line"></i></a>
                                <p class="mx-2">
                                    <%= elem.quantity %>
                                </p>
                                <button class="px-2 py-1 rounded"><i class="ri-add-line"></i></button>
                            </div>
                            <div class="flex gap-2 mt-4">
                                <p class="text-gray-500 line-through">₹<%= Number(elem.price) * Number(elem.quantity) +
                                        20 %>
                                </p>
                                <p>₹<%= Number(elem.price) * Number(elem.quantity) %>
                                </p>
                            </div>
                        </div>
                    </div>
                    <% }) %>
            </div>


            <div class="bg-white p-4 rounded-lg shadow mb-4">
                <h2 class="text-lg font-semibold">Before you checkout</h2>
                <div class="flex space-x-4 mt-4 flex-wrap">
                    <% cart.forEach(item=> { %>
                        <div class="flex flex-col items-center">
                            <img src="data:image/jpg;base64, <%= item.image.toString('base64') %>"
                                alt="<%= item.name %>" class="h-24 rounded">
                            <p class="text-sm text-center mt-2">
                                <%= item.name %>
                            </p>
                            <p class="text-xs text-gray-500">
                                <%= item.weight %>
                                    <button class="bg-green-700 text-white px-4 py-1 rounded mt-2">ADDED</button>
                                    <p class="text-xs mt-2">₹<%= item.price %>
                                    </p>
                                    <% if(item.discount) { %>
                                        <p class="text-xs text-red-500">
                                            <%= item.discount %> OFF
                                        </p>
                                        <% } %>
                        </div>
                        <% }) %>
                </div>

            </div>


            <div class="bg-white p-4 rounded-lg shadow mb-4">
                <h2 class="text-lg font-semibold">Bill details</h2>
                <div class="mt-2">
                    <div class="flex justify-between">
                        <p class="text-sm">Items total</p>
                        <p class="text-sm">₹<%= finalprice - 34 %>
                        </p>
                    </div>
                    <div class="flex justify-between">
                        <p class="text-sm">Delivery charge</p>
                        <p class="text-sm">₹30</p>
                    </div>
                    <div class="flex justify-between">
                        <p class="text-sm">Handling charge</p>
                        <p class="text-sm">₹4</p>
                    </div>
                    <div class="flex justify-between font-bold mt-2">
                        <p class="text-lg">Grand total</p>
                        <p class="text-lg">₹<%= finalprice %>
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow fixed bottom-0 inset-x-0">
                <div class="flex justify-between items-center mt-2">
                    <div>
                        <p class="text-sm">PAY USING</p>
                        <p class="text-xs text-gray-500">Paytm UPI</p>
                    </div>
                    <div>
                        <p class="text-lg font-bold">₹ <%= finalprice=(cart.length==0) ? 0 : finalprice %>
                        </p>
                        <button class="paybtn bg-green-700 text-white px-4 py-2 rounded">Place Order</button>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow mb-4">
                <div class="flex items-center">
                    <img src="https://b.zmtcdn.com/data/fi_assets/9fbf0569f69bfef7d190c5b892ab0a521619355737.png"
                        alt="Feeding India" class="w-12 h-12 rounded">
                    <div class="ml-4">
                        <p class="font-semibold">Feeding India donation</p>
                        <p class="text-sm opacity-50">Working towards a malnutrition free India. Feeding India...<span
                                class="text-blue-500">read more</span></p>
                    </div>
                    <p class="ml-auto text-sm font-bold">₹1</p>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow">
                <h2 class="text-lg font-semibold">Delivery instructions</h2>
                <div class="flex space-x-4 mt-4">
                    <button class="flex-1 flex flex-col items-center justify-center py-2 bg-gray-100 rounded">
                        <i class="ri-mic-line"></i>
                        <p class="text-sm">Record</p>
                    </button>
                    <button class="flex-1 flex flex-col items-center justify-center py-2 bg-gray-100 rounded">
                        <i class="ri-prohibited-line"></i>
                        <p class="leading-none text-sm">Avoid calling</p>
                    </button>
                    <button class="flex-1 flex flex-col items-center justify-center py-2 bg-gray-100 rounded">
                        <i class="ri-notification-off-line"></i>
                        <p class="text-sm">Don't ring the bell</p>
                    </button>
                    <button class="flex-1 flex flex-col items-center justify-center py-2 bg-gray-100 rounded">
                        <i class="ri-door-open-line"></i>
                        <p class="text-sm">Leave at door</p>
                    </button>
                </div>
            </div>


            <div class="bg-white p-4 rounded-lg shadow mt-10">Ordering for someone else? Add details</div>

            <div class="bg-white p-4 rounded-lg shadow mb-40 mt-10">
                <p class="text-sm">
                    Orders cannot be cancelled once packed for delivery. In case of unexpected delays, a refund will be
                    provided, if applicable.
                </p>
            </div>

        </div>

        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

        <script>
            document.querySelector('.paybtn').onclick = function (e) {
                axios.post('/payment/create/orderId', {
                    totalAmount: <%= finalprice %>  
            })
            .then(function (response) {
                        var options = {
                            "key": "<%= process.env.RAZORPAY_KEY_ID %>",
                            "amount": response.data.amount,
                            "currency": response.data.currency,
                            "name": "BlinkIt",
                            "description": "Test Transaction",
                            "order_id": response.data.id,
                            "handler": function (paymentResponse) {
                                axios.post('/payment/api/payment/verify', {
                                    razorpayOrderId: paymentResponse.razorpay_order_id,
                                    razorpayPaymentId: paymentResponse.razorpay_payment_id,
                                    signature: paymentResponse.razorpay_signature
                                })
                                    .then(function (verifyResponse) {
                                        let { orderId } = verifyResponse.data;
                                        window.location.href = `/map/${orderId}`;
                                    })
                                    .catch(function (error) {
                                        console.error('Payment verification failed:', error);
                                        alert('Payment verification failed. Please try again.');
                                    });
                            },
                            "prefill": {
                                "name": "Kunal Lokhande",
                                "email": "kunal@gmail.com",
                                "contact": "9000090000"
                            },
                            "theme": {
                                "color": "#3399cc"
                            }
                        };

                        var rzp1 = new Razorpay(options);
                        rzp1.on('payment.failed', function (response) {
                            console.error('Payment Failed:', response.error);
                            alert('Payment failed. Please try again later.');
                        });

                        rzp1.open();
                        e.preventDefault();
                    })
                .catch(function (error) {
                    console.error('Payment creation failed:', error);
                    alert('Failed to create payment. Please try again.');
                });
        };
        </script>


    </body>
    <%- include('./partials/footer'); %>